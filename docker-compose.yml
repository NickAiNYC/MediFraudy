
services:
  postgres:
    image: postgres:14-alpine
    container_name: medicaid_postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-medicaid_db}
      POSTGRES_USER: ${POSTGRES_USER:-analyst}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-changeme_in_production}
      POSTGRES_HOST_AUTH_METHOD: trust
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backend/init-db.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - medicaid_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-analyst} -d ${POSTGRES_DB:-medicaid_db}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  redis:
    image: redis:7-alpine
    container_name: medicaid_redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    networks:
      - medicaid_network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Placeholder for Kafka (Message Queue)
  # kafka:
  #   image: confluentinc/cp-kafka:latest
  #   ...

  # Placeholder for Elasticsearch
  # elasticsearch:
  #   image: docker.elastic.co/elasticsearch/elasticsearch:8.10.2
  #   ...

  backend:
    build: 
      context: ./backend
      dockerfile: Dockerfile
    container_name: medicaid_backend
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      # Database
      DATABASE_URL: postgresql://${POSTGRES_USER:-analyst}:${DB_PASSWORD:-changeme_in_production}@postgres:5432/${POSTGRES_DB:-medicaid_db}?sslmode=disable
      DB_POOL_SIZE: ${DB_POOL_SIZE:-20}
      DB_MAX_OVERFLOW: ${DB_MAX_OVERFLOW:-10}
      
      # App
      DEBUG: ${DEBUG:-True}
      ENVIRONMENT: ${ENVIRONMENT:-development}
      SECRET_KEY: ${SECRET_KEY:-development_secret_key_change_in_production}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      
      # Dataset
      MEDICAID_DATASET_URL: ${MEDICAID_DATASET_URL}
      MEDICAID_DATASET_CHECKSUM: ${MEDICAID_DATASET_CHECKSUM}
      CHUNK_SIZE: ${CHUNK_SIZE:-50000}
      
      # Infrastructure
      REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
      
      # POL Cache
      ENABLE_POL_CACHE: ${ENABLE_POL_CACHE:-True}
      POL_CACHE_DAYS: ${POL_CACHE_DAYS:-7}
      
      # CORS
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:3000}
    volumes:
      - ./data:/app/data
      - ./exports:/app/exports
      - ./logs:/app/logs
      - ./backend:/app  # Mount for development (remove in production)
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - medicaid_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  frontend:
    build: 
      context: ./frontend
      dockerfile: Dockerfile
    container_name: medicaid_frontend
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      REACT_APP_API_URL: ${REACT_APP_API_URL:-http://localhost:8000}
      NODE_ENV: ${NODE_ENV:-production}
    volumes:
      - ./frontend:/app  # Mount for development (remove in production)
      - /app/node_modules
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - medicaid_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Optional: Adminer for database management (development only)
  adminer:
    image: adminer:4
    container_name: medicaid_adminer
    restart: unless-stopped
    ports:
      - "8080:8080"
    networks:
      - medicaid_network
    depends_on:
      - postgres
    profiles:
      - dev
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  medicaid_network:
    driver: bridge
    name: medicaid_network

volumes:
  postgres_data:
    name: medicaid_postgres_data
    driver: local
